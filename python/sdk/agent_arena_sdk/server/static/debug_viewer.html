<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Arena Debug Viewer</title>
  <style>
    /* ── Reset & Base ──────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-0: #121212;
      --bg-1: #1e1e1e;
      --bg-2: #2a2a2a;
      --bg-3: #333;
      --border: #3a3a3a;
      --text: #e0e0e0;
      --text-muted: #888;
      --accent: #4a90e2;
      --stage-observation: #4a90e2;
      --stage-retrieved: #3498db;
      --stage-prompt: #e67e22;
      --stage-llm_request: #9b59b6;
      --stage-response: #2ecc71;
      --stage-decision: #e74c3c;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-0);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ────────────────────────────────────────────────── */
    header {
      background: var(--bg-2);
      padding: 0.75rem 1.5rem;
      border-bottom: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    header h1 { font-size: 1.3rem; font-weight: 600; }

    .controls { display: flex; gap: 0.75rem; align-items: center; }

    .btn {
      padding: 0.4rem 0.9rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #357ab8; }
    .btn-secondary { background: #555; color: #fff; }
    .btn-secondary:hover { background: #666; }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
    }
    .live-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #2ecc71;
      animation: pulse 2s infinite;
    }
    .live-dot.paused { background: #888; animation: none; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* ── Main layout ───────────────────────────────────────────── */
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 220px 1fr 380px;
      overflow: hidden;
    }

    /* ── Sidebar ───────────────────────────────────────────────── */
    .sidebar {
      background: var(--bg-1);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 1rem;
    }
    .sidebar h2 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .search-box {
      width: 100%;
      padding: 0.5rem 0.7rem;
      background: var(--bg-0);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }
    .search-box:focus { outline: none; border-color: var(--accent); }

    .agent-list { list-style: none; }
    .agent-item {
      padding: 0.6rem 0.75rem;
      margin-bottom: 0.35rem;
      background: var(--bg-0);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.15s;
    }
    .agent-item:hover { background: var(--bg-3); }
    .agent-item.active { background: var(--accent); color: #fff; }

    .view-tabs {
      display: flex;
      gap: 0.25rem;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.4rem;
      font-size: 0.75rem;
      text-align: center;
      background: var(--bg-0);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      cursor: pointer;
    }
    .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* ── Trace viewer (center) ─────────────────────────────────── */
    .trace-viewer {
      overflow-y: auto;
      padding: 1.5rem;
    }

    .trace-item {
      background: var(--bg-1);
      border-radius: 6px;
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .trace-header {
      padding: 0.75rem 1rem;
      background: var(--bg-2);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .trace-header:hover { background: var(--bg-3); }
    .trace-title { font-weight: 600; font-size: 1rem; }
    .trace-meta { font-size: 0.8rem; color: var(--text-muted); }
    .trace-expand { font-size: 0.8rem; color: var(--text-muted); transition: transform 0.2s; }
    .trace-expand.open { transform: rotate(90deg); }

    .trace-body { display: none; padding: 0.75rem 1rem; }
    .trace-body.expanded { display: block; }

    /* ── Steps ─────────────────────────────────────────────────── */
    .step {
      margin-bottom: 0.6rem;
      padding: 0.5rem 0.75rem;
      border-left: 3px solid var(--accent);
      border-radius: 0 4px 4px 0;
      background: var(--bg-0);
      cursor: pointer;
      transition: background 0.1s;
    }
    .step:hover { background: var(--bg-2); }
    .step.selected { background: var(--bg-2); outline: 1px solid var(--accent); }

    .step-header { display: flex; justify-content: space-between; align-items: center; }
    .step-name { font-weight: 600; font-size: 0.9rem; }
    .step-timing { font-size: 0.8rem; color: var(--text-muted); }

    .step-preview {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Stage colors */
    .step[data-stage="observation"]  { border-left-color: var(--stage-observation); }
    .step[data-stage="retrieved"]    { border-left-color: var(--stage-retrieved); }
    .step[data-stage="prompt"]       { border-left-color: var(--stage-prompt); }
    .step[data-stage="llm_request"]  { border-left-color: var(--stage-llm_request); }
    .step[data-stage="llm_response"] { border-left-color: var(--stage-response); }
    .step[data-stage="response"]     { border-left-color: var(--stage-response); }
    .step[data-stage="parse"]        { border-left-color: #f39c12; }
    .step[data-stage="decision"]     { border-left-color: var(--stage-decision); }

    .step-name[data-stage="observation"]  { color: var(--stage-observation); }
    .step-name[data-stage="retrieved"]    { color: var(--stage-retrieved); }
    .step-name[data-stage="prompt"]       { color: var(--stage-prompt); }
    .step-name[data-stage="llm_request"]  { color: var(--stage-llm_request); }
    .step-name[data-stage="llm_response"] { color: var(--stage-response); }
    .step-name[data-stage="response"]     { color: var(--stage-response); }
    .step-name[data-stage="parse"]        { color: #f39c12; }
    .step-name[data-stage="decision"]     { color: var(--stage-decision); }

    /* ── Detail panel (right) ──────────────────────────────────── */
    .detail-panel {
      background: var(--bg-1);
      border-left: 1px solid var(--border);
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .detail-panel h2 {
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--accent);
    }
    .detail-placeholder {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-top: 2rem;
      text-align: center;
    }
    .detail-json {
      background: var(--bg-0);
      padding: 0.75rem;
      border-radius: 4px;
      font-family: "Cascadia Code", "Fira Code", "Consolas", monospace;
      font-size: 0.82rem;
      line-height: 1.5;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      flex: 1;
    }
    .detail-meta {
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
    }
    .detail-meta span { color: var(--text-muted); }

    /* ── Tick scrubber ─────────────────────────────────────────── */
    .scrubber {
      padding: 0.5rem 1.5rem;
      background: var(--bg-2);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .scrubber label { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; }
    .scrubber input[type="range"] { flex: 1; accent-color: var(--accent); }
    .scrubber .tick-display { font-size: 0.85rem; min-width: 5rem; text-align: right; }

    /* ── Empty state ───────────────────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }
    .empty-state h2 { margin-bottom: 0.5rem; font-size: 1.2rem; color: var(--text); }
    .empty-state p { font-size: 0.9rem; }
  </style>
</head>
<body>

<header>
  <h1>Agent Arena Debug Viewer</h1>
  <div class="controls">
    <div class="live-indicator">
      <span class="live-dot" id="liveDot"></span>
      <span id="liveLabel">Live</span>
    </div>
    <button class="btn btn-secondary" id="toggleLiveBtn">Pause</button>
    <button class="btn btn-primary" id="refreshBtn">Refresh</button>
  </div>
</header>

<main>
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>Agents</h2>
    <input type="text" class="search-box" id="agentSearch" placeholder="Filter agents...">
    <ul class="agent-list" id="agentList"></ul>

    <div class="view-tabs">
      <button class="tab-btn active" data-view="traces" id="tabTraces">Traces</button>
      <button class="tab-btn" data-view="observations" id="tabObservations">Obs</button>
    </div>

    <h2 style="margin-top:1rem;">Tool Filter</h2>
    <select class="search-box" id="toolFilter" style="cursor:pointer;">
      <option value="">All tools</option>
      <option value="move_to">move_to</option>
      <option value="collect">collect</option>
      <option value="idle">idle</option>
    </select>
  </aside>

  <!-- Center: trace / observation list -->
  <section class="trace-viewer" id="traceContainer"></section>

  <!-- Right: detail panel -->
  <aside class="detail-panel">
    <h2 id="detailTitle">Details</h2>
    <div id="detailContent">
      <p class="detail-placeholder">Select a trace step to view full data</p>
    </div>
  </aside>
</main>

<!-- Tick scrubber -->
<div class="scrubber" id="scrubberBar">
  <label for="tickSlider">Tick range:</label>
  <input type="range" id="tickSlider" min="0" max="100" value="100">
  <div class="tick-display" id="tickDisplay">all</div>
</div>

<script type="module">
  // ── State ──────────────────────────────────────────────────
  let liveMode = true;
  let liveInterval = null;
  let currentAgent = null;
  let currentView = 'traces';  // 'traces' | 'observations'
  let traces = [];
  let observations = [];
  let agents = [];
  let tickMax = 0;
  let tickFilter = null; // null = show all
  let toolFilter = '';   // '' = show all

  // Track expanded/selected state so live refresh preserves it
  let expandedTraceIds = new Set();
  let selectedStepKey = null; // "traceId:stepIdx"

  // ── DOM refs ───────────────────────────────────────────────
  const $agentList = document.getElementById('agentList');
  const $agentSearch = document.getElementById('agentSearch');
  const $traceContainer = document.getElementById('traceContainer');
  const $detailTitle = document.getElementById('detailTitle');
  const $detailContent = document.getElementById('detailContent');
  const $liveDot = document.getElementById('liveDot');
  const $liveLabel = document.getElementById('liveLabel');
  const $toggleLiveBtn = document.getElementById('toggleLiveBtn');
  const $refreshBtn = document.getElementById('refreshBtn');
  const $tickSlider = document.getElementById('tickSlider');
  const $tickDisplay = document.getElementById('tickDisplay');
  const $tabTraces = document.getElementById('tabTraces');
  const $tabObservations = document.getElementById('tabObservations');
  const $toolFilter = document.getElementById('toolFilter');

  // ── API helpers ────────────────────────────────────────────
  async function api(path) {
    try {
      const r = await fetch(path);
      if (!r.ok) return null;
      return await r.json();
    } catch { return null; }
  }

  async function fetchAgents() {
    const data = await api('/debug/agents');
    agents = data?.agents ?? [];
    renderAgentList();
  }

  async function fetchTraces() {
    let url = '/debug/traces?limit=200';
    if (currentAgent) url += `&agent_id=${encodeURIComponent(currentAgent)}`;
    if (toolFilter) url += `&tool=${encodeURIComponent(toolFilter)}`;
    const data = await api(url);
    traces = data?.traces ?? [];
    if (traces.length > 0) {
      tickMax = Math.max(...traces.map(t => t.tick));
      $tickSlider.max = tickMax;
    }
    if (currentView === 'traces') renderTraces();
  }

  async function fetchObservations() {
    let url = '/debug/observations?limit=200';
    if (currentAgent) url += `&agent_id=${encodeURIComponent(currentAgent)}`;
    const data = await api(url);
    observations = data?.observations ?? [];
    if (currentView === 'observations') renderObservations();
  }

  async function refreshAll() {
    await Promise.all([fetchAgents(), fetchTraces(), fetchObservations()]);
  }

  // ── Renderers ──────────────────────────────────────────────

  function renderAgentList() {
    const filter = $agentSearch.value.toLowerCase();
    const filtered = agents.filter(a => a.toLowerCase().includes(filter));
    if (filtered.length === 0) {
      $agentList.innerHTML = '<li style="color:var(--text-muted);padding:0.75rem;font-size:0.85rem;">No agents found</li>';
      return;
    }
    $agentList.innerHTML = filtered.map(a => `
      <li class="agent-item ${currentAgent === a ? 'active' : ''}"
          onclick="window._selectAgent('${a}')">${a}</li>
    `).join('');
  }

  function renderTraces() {
    let items = traces;
    if (tickFilter !== null) {
      items = items.filter(t => t.tick <= tickFilter);
    }
    if (items.length === 0) {
      $traceContainer.innerHTML = `
        <div class="empty-state">
          <h2>No traces yet</h2>
          <p>Run an agent with <code>AgentArena(enable_debug=True)</code> to see traces here.</p>
        </div>`;
      return;
    }
    // Show most recent first
    const sorted = [...items].reverse();
    $traceContainer.innerHTML = sorted.map((trace, i) => {
      const idx = items.length - 1 - i;
      const tid = trace.trace_id;
      const isExpanded = expandedTraceIds.has(tid);
      const time = new Date(trace.start_time * 1000).toLocaleTimeString();
      return `
        <div class="trace-item">
          <div class="trace-header" onclick="window._toggleTrace('${tid}', ${idx})">
            <div>
              <span class="trace-title">Tick ${trace.tick}</span>
              <span class="trace-meta">&nbsp;- ${trace.agent_id} &middot; ${trace.steps.length} steps &middot; ${tid}</span>
            </div>
            <div>
              <span class="trace-meta">${time}</span>
              <span class="trace-expand ${isExpanded ? 'open' : ''}" id="arrow-${idx}">&#9654;</span>
            </div>
          </div>
          <div class="trace-body ${isExpanded ? 'expanded' : ''}" id="tbody-${idx}">
            ${renderSteps(trace.steps, idx, tid)}
          </div>
        </div>`;
    }).join('');
  }

  function renderSteps(steps, traceIdx, traceId) {
    return steps.map((step, si) => {
      const preview = previewData(step.data);
      const stepKey = `${traceId}:${si}`;
      const isSelected = selectedStepKey === stepKey;
      return `
        <div class="step ${isSelected ? 'selected' : ''}" data-stage="${step.name}"
             onclick="event.stopPropagation(); window._selectStep(${traceIdx}, ${si}, '${traceId}')">
          <div class="step-header">
            <span class="step-name" data-stage="${step.name}">${step.name}</span>
            <span class="step-timing">${step.elapsed_ms.toFixed(1)}ms</span>
          </div>
          <div class="step-preview">${escapeHtml(preview)}</div>
        </div>`;
    }).join('');
  }

  function renderObservations() {
    if (observations.length === 0) {
      $traceContainer.innerHTML = `
        <div class="empty-state">
          <h2>No observations yet</h2>
          <p>Observations are recorded when Godot sends data to the agent.</p>
        </div>`;
      return;
    }
    const sorted = [...observations].reverse();
    $traceContainer.innerHTML = sorted.map(obs => {
      const hasChange = obs.gained_resources.length || obs.lost_resources.length
                     || obs.gained_hazards.length || obs.lost_hazards.length;
      const changeBadge = hasChange ? '<span style="color:#e67e22;font-weight:600;"> CHANGED</span>' : '';
      return `
        <div class="trace-item">
          <div class="trace-header" onclick="window._showObsDetail(${JSON.stringify(obs).replace(/"/g, '&quot;')})">
            <div>
              <span class="trace-title">Tick ${obs.tick}</span>
              <span class="trace-meta">&nbsp;- ${obs.agent_id}${changeBadge}</span>
            </div>
            <div>
              <span class="trace-meta">${obs.visible_resources.length} res, ${obs.visible_hazards.length} haz</span>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  function showDetail(title, data) {
    $detailTitle.textContent = title;
    $detailContent.innerHTML = `<div class="detail-json">${escapeHtml(JSON.stringify(data, null, 2))}</div>`;
  }

  // ── Helpers ────────────────────────────────────────────────

  function previewData(data) {
    if (data === null || data === undefined) return '(none)';
    if (typeof data === 'string') return data.length > 120 ? data.slice(0, 120) + '...' : data;
    if (typeof data === 'object') {
      const parts = [];

      // Decision step: tool + params
      if (data.tool) {
        let toolStr = `tool: ${data.tool}`;
        if (data.params) {
          const p = data.params;
          if (p.target_position) {
            const pos = p.target_position.map(v => typeof v === 'number' ? v.toFixed(1) : v);
            toolStr += ` → [${pos.join(', ')}]`;
          } else if (p.target_name) {
            toolStr += ` → "${p.target_name}"`;
          }
        }
        parts.push(toolStr);
      }

      // Observation step
      if (data.position) parts.push(`pos: [${data.position.map(v => typeof v === 'number' ? v.toFixed(1) : v).join(', ')}]`);
      if (data.health !== undefined) parts.push(`hp: ${data.health}`);
      if (data.energy !== undefined) parts.push(`energy: ${data.energy}`);
      if (data.nearby_resources !== undefined) parts.push(`resources: ${data.nearby_resources}`);
      if (data.nearby_hazards !== undefined) parts.push(`hazards: ${data.nearby_hazards}`);

      // LLM response step
      if (data.raw_output !== undefined) {
        const output = String(data.raw_output).trim();
        const preview = output.length > 80 ? output.slice(0, 80) + '...' : output;
        parts.push(preview);
        if (data.tokens_used) parts.push(`${data.tokens_used} tokens`);
      }

      // Parse step
      if (data.method !== undefined) {
        parts.push(`method: ${data.method}`);
        if (data.parsed_json) parts.push(`tool: ${data.parsed_json.tool || '?'}`);
      }

      // Prompt step
      if (data.user_prompt !== undefined) {
        const prompt = String(data.user_prompt).trim();
        parts.push(prompt.length > 80 ? prompt.slice(0, 80) + '...' : prompt);
      }

      // Reasoning
      if (data.reasoning && !data.tool) parts.push(`"${String(data.reasoning).slice(0, 50)}"`);

      if (parts.length) return parts.join(', ');
      const json = JSON.stringify(data);
      return json.length > 120 ? json.slice(0, 120) + '...' : json;
    }
    return String(data);
  }

  function escapeHtml(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // ── Global handlers (called from inline onclick) ───────────

  window._selectAgent = function(agentId) {
    currentAgent = currentAgent === agentId ? null : agentId;
    renderAgentList();
    fetchTraces();
    fetchObservations();
  };

  window._toggleTrace = function(traceId, idx) {
    if (expandedTraceIds.has(traceId)) {
      expandedTraceIds.delete(traceId);
    } else {
      expandedTraceIds.add(traceId);
    }
    const body = document.getElementById(`tbody-${idx}`);
    const arrow = document.getElementById(`arrow-${idx}`);
    if (body) {
      body.classList.toggle('expanded');
      arrow?.classList.toggle('open');
    }
  };

  window._selectStep = function(traceIdx, stepIdx, traceId) {
    // Clear previous selection
    document.querySelectorAll('.step.selected').forEach(el => el.classList.remove('selected'));

    // Track selection state
    const stepKey = `${traceId}:${stepIdx}`;
    selectedStepKey = stepKey;

    // Find the visible trace items (rendered in reverse order)
    const items = tickFilter !== null ? traces.filter(t => t.tick <= tickFilter) : traces;
    const trace = items[traceIdx];
    if (!trace) return;
    const step = trace.steps[stepIdx];
    if (!step) return;

    // Highlight selected step
    const traceItems = document.querySelectorAll('.trace-item');
    const visibleIdx = items.length - 1 - traceIdx;
    const traceEl = traceItems[visibleIdx];
    if (traceEl) {
      const stepEls = traceEl.querySelectorAll('.step');
      stepEls[stepIdx]?.classList.add('selected');
    }

    showDetail(`${step.name} (Tick ${trace.tick})`, step.data);
  };

  window._showObsDetail = function(obs) {
    showDetail(`Observation (Tick ${obs.tick})`, obs);
  };

  // ── Controls ───────────────────────────────────────────────

  $toggleLiveBtn.addEventListener('click', () => {
    liveMode = !liveMode;
    if (liveMode) {
      $liveDot.classList.remove('paused');
      $liveLabel.textContent = 'Live';
      $toggleLiveBtn.textContent = 'Pause';
      startLive();
    } else {
      $liveDot.classList.add('paused');
      $liveLabel.textContent = 'Paused';
      $toggleLiveBtn.textContent = 'Resume';
      stopLive();
    }
  });

  $refreshBtn.addEventListener('click', refreshAll);

  $agentSearch.addEventListener('input', renderAgentList);

  $tickSlider.addEventListener('input', () => {
    const val = parseInt($tickSlider.value);
    if (val >= tickMax) {
      tickFilter = null;
      $tickDisplay.textContent = 'all';
    } else {
      tickFilter = val;
      $tickDisplay.textContent = `0 - ${val}`;
    }
    if (currentView === 'traces') renderTraces();
  });

  $toolFilter.addEventListener('change', () => {
    toolFilter = $toolFilter.value;
    fetchTraces();
  });

  $tabTraces.addEventListener('click', () => {
    currentView = 'traces';
    $tabTraces.classList.add('active');
    $tabObservations.classList.remove('active');
    renderTraces();
  });

  $tabObservations.addEventListener('click', () => {
    currentView = 'observations';
    $tabObservations.classList.add('active');
    $tabTraces.classList.remove('active');
    renderObservations();
  });

  // ── Live polling ───────────────────────────────────────────

  function startLive() {
    if (liveInterval) return;
    liveInterval = setInterval(() => {
      fetchTraces();
      fetchObservations();
    }, 2000);
  }

  function stopLive() {
    if (liveInterval) { clearInterval(liveInterval); liveInterval = null; }
  }

  // ── Init ───────────────────────────────────────────────────
  refreshAll();
  startLive();
</script>
</body>
</html>
